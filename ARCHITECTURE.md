# Архитектура FamOS - Family Operating System

## Обзор

FamOS - это полноценное приложение для автоматизации WhatsApp, которое:
- Анализирует все ваши чаты (текущие и старые)
- Изучает вашу манеру общения
- Может отвечать вместо вас в вашем стиле
- Генерирует ежедневные отчеты о активности

## Архитектура

### Компоненты

#### 1. **WhatsApp Producer (WaService)**
- Подключается к WhatsApp через `whatsapp-web.js`
- Слушает все входящие и исходящие сообщения
- Отправляет сообщения в Redis очередь для асинхронной обработки

#### 2. **Message Processor**
- Обрабатывает сообщения из Redis очереди
- Сохраняет все сообщения в MongoDB
- Обновляет информацию о чатах
- Отправляет автоматические ответы (если включено)

#### 3. **Chat Sync Service**
- Синхронизирует все чаты при запуске
- Загружает историю сообщений (до 1000 сообщений на чат)
- Сохраняет информацию о чатах и участниках

#### 4. **User Style Service**
- Анализирует ваши сообщения для изучения стиля общения
- Извлекает:
  - Частые фразы и выражения
  - Среднюю длину сообщений
  - Использование эмодзи
  - Стиль пунктуации
  - Словарь и частые слова
  - Паттерны ответов (приветствия, прощания, вопросы)

#### 5. **AI Response Service**
- Генерирует ответы на основе вашего стиля общения
- Использует изученные паттерны и фразы
- Может автоматически отвечать на входящие сообщения

#### 6. **Daily Report Service**
- Генерирует ежедневные отчеты в 1:00 AM
- Включает статистику:
  - Общее количество сообщений
  - Входящие/исходящие сообщения
  - Активные чаты
  - Топ контактов
  - Активность по часам
  - Insights и highlights

#### 7. **REST API**
- Управление системой через HTTP endpoints
- Получение статистики и отчетов
- Включение/выключение автоответов

## База данных (MongoDB)

### Схемы

1. **Message** - Все сообщения (входящие и исходящие)
   - messageId, chatId, sender, text, fromMe, timestamp
   - Индексы для быстрого поиска

2. **Chat** - Информация о чатах
   - chatId, name, isGroup, participants, messageCount
   - lastMessageAt для сортировки

3. **UserStyle** - Профиль стиля общения
   - styleProfile с детальным анализом
   - analyzedMessagesCount

4. **DailyReport** - Ежедневные отчеты
   - statistics, aiActivity, highlights, insights

## Очередь (Redis)

- **Queue**: `message-processing`
- **Job Type**: `analyze-message`
- Обработка сообщений асинхронно через BullMQ

## Поток данных

```
WhatsApp → WaService → Redis Queue → MessageProcessor → MongoDB
                                              ↓
                                    AI Response Service (если включено)
                                              ↓
                                         WhatsApp (ответ)
```

## API Endpoints

### Управление
- `GET /api/health` - Проверка статуса
- `POST /api/sync-chats` - Запустить синхронизацию чатов
- `POST /api/analyze-style` - Проанализировать стиль общения
- `GET /api/style` - Получить профиль стиля

### Автоответы
- `POST /api/auto-reply` - Включить/выключить автоответы
- `GET /api/auto-reply` - Статус автоответов

### Отчеты
- `GET /api/reports` - Последние отчеты
- `GET /api/reports/:date` - Отчет за конкретную дату

### Статистика
- `GET /api/stats` - Общая статистика
- `GET /api/chats` - Список всех чатов
- `GET /api/chats/:chatId/messages` - Сообщения чата

## Как это работает

### 1. Первый запуск
1. Приложение подключается к WhatsApp (QR код)
2. После подключения автоматически синхронизируются все чаты
3. Все сообщения сохраняются в MongoDB

### 2. Анализ стиля
1. Вызовите `POST /api/analyze-style`
2. Система проанализирует ваши сообщения (до 10000)
3. Создаст профиль стиля общения

### 3. Автоответы
1. Включите автоответы: `POST /api/auto-reply {"enabled": true}`
2. Система будет автоматически отвечать на входящие сообщения
3. Ответы генерируются на основе вашего стиля

### 4. Ежедневные отчеты
- Генерируются автоматически в 1:00 AM
- Доступны через `GET /api/reports`

## Улучшения для продакшена

1. **ML/AI модели**:
   - Использовать OpenAI API или локальные модели для генерации ответов
   - Fine-tuning модели на ваших сообщениях

2. **Безопасность**:
   - Аутентификация для API
   - Шифрование данных
   - Rate limiting

3. **Масштабирование**:
   - Горизонтальное масштабирование через несколько воркеров
   - Кэширование часто используемых данных

4. **Веб-интерфейс**:
   - Dashboard для просмотра статистики
   - Управление автоответами
   - Просмотр отчетов

5. **Уведомления**:
   - Email/Telegram уведомления о важных событиях
   - Алерты о необычной активности
